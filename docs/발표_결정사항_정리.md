# AI 추천 서비스 — 결정 사항 정리 (발표용)

## 1. 서비스 개요

- **역할**: 내담자 프로필 기반 **유사 케이스 검색** + **GPT 추천** 제공
- **형식**: 입력·출력 모두 **JSON**
- **구성**: Python + FastAPI + Uvicorn, Docker로 배포 후 **Java 백엔드에서 HTTP로 호출**

---

## 2. 입력·출력

### 입력 (Java → AI 서비스)

- **엔드포인트**: `POST /api/v1/recommend`
- **JSON 예시**: `{ "clientId": 1, "topK": 5 }`
- 내담자 상세(이름, 생년월일/주민번호, 나이, 성별, 학력, 전공, 희망직종, 역량, 주소, 학교 등)는 **DB에서 clientId로 조회**하여 사용

### 출력 (AI 서비스 → Java)

- **clientId**, **maskedInput**(이름·주민번호 마스킹된 프로필), **queryText**(임베딩에 쓴 텍스트)
- **similarCases**: 유사 케이스 Top-K (score, 나이, 성별, 희망직종, 역량, 학력, 전공, 학교, 취업직무·회사·급여, 훈련과정, 상담요약 등, **주소 제외**)
- **recommendation**:
  - **recommendedJobsByProfile**: 나이·성별·학력·역량·전공만 고려한 추천 직무(최대 3개)
  - **recommendedJobsByDesiredJob**: 희망직종 반영 추천 직무(최대 3개)
  - **recommendedTrainings**: 추천 직업훈련과정명
  - **recommendedCompanies**: 추천 취업처
  - **expectedSalaryRange**: 급여 수준(예: "2,500,000원 ~ 3,200,000원")
  - **suggestedServices**: 제안 서비스(직업심리검사, 일경험, 국민취업지원제도 연계 상담 등)
  - **coreQuestions**: 이번 상담 핵심 질문(내담자 의지 파악용)
  - **reason**: (선택) 추천 이유

---

## 3. 임베딩·유사도 검색 (RAG 1단계)

### 임베딩에 쓰는 정보 (결정)

- **나이, 성별, 희망직종**만 사용
- 희망직종 없으면 `"(미정)"`으로 넣음
- **사용 모델**: OpenAI `text-embedding-3-small`

### 유사도 검색

- DB에 저장된 내담자 **embedding**과 **코사인 거리**로 비교
- 거리 작은 순 **Top-K** (기본 5, 최대 20)
- **조건**: `employment` 테이블에 **job_title**이 있는 내담자만 검색 대상 (실제 취업 이력이 있는 케이스만)
- 유사 케이스로 merge할 때 **주소(address)는 제외**하여 반환 (개인정보 최소화)

### 임베딩 갱신

- 요청 시 **나이·성별·희망직종**으로 만든 텍스트의 **해시**를 DB의 `embedding_source_hash`와 비교
- 해시가 다르면 → 새로 임베딩 계산 후 DB에 **덮어쓰기**
- 해시가 같으면 → 기존 임베딩 그대로 사용

---

## 4. 개인정보 보호 (GPT 전달 시)

- **이름**: 일부 마스킹 (예: "홍길동" → "홍*동")
- **주민등록번호**: 앞 6자리만 두고 뒤 7자리 마스킹 (예: "900101-*******")
- GPT에는 **마스킹된 payload(maskedInput)**만 전달
- 응답은 **clientId·마스킹 규칙**으로 원래 대상과 매칭

---

## 5. 추천 로직 (규칙 기반 + GPT)

### 규칙 기반

- 유사 케이스의 **훈련과정·취업직무·회사·급여**를 모아 중복 제거·정규화 후 리스트로 채움
- **suggestedServices**, **coreQuestions**는 고정 템플릿으로 제공 가능 (GPT가 보강할 수도 있음)

### GPT 활용

- **희망직종이 있을 때**: 유사 케이스 + 희망직종을 반영해 직무·훈련·연봉·서비스·질문 추천
- **희망직종이 없을 때**: 프로필·유사 케이스만으로 **희망직종 후보(추천 직무) 최대 3개**까지 포함해 추천
- **모델**: `gpt-4o-mini` (환경변수로 변경 가능)
- **타임아웃**: 12초 등 설정 가능

### 추천 모드 (환경변수 `RECOMMEND_MODE`)

| 모드 | 목표 | 유사 케이스 수(LLM) | 출력 토큰 상한 |
|------|------|----------------------|----------------|
| **fast** (기본) | 약 5초 이내 응답 | 3건 | 380 |
| **accuracy** | 정확도 우선 | 5건 | 550 |

---

## 6. DB·데이터

### 필수

- **PostgreSQL + pgvector** 확장
- **clients** 테이블 (id, name, resident_id, age, gender, education, desired_job, competency, address, university, major, **embedding** 등)
  - 팀에서 사용하는 DB/스키마와 동일하게 각자 로컬에 설치

### 선택 (있으면 유사 케이스에 포함)

- **employment**: 취업 이력 (job_title 있는 행만 유사 케이스 검색에 사용)
- **training**: 직업훈련 이력
- **consultation**: 상담 내역

### 데이터 적재

- **상담리스트_가공데이터_202602.xlsx** 등 엑셀 → `POST /api/v1/ingest-employment-training` 호출로 **employment**, **training**, **consultation** 채움
- 이때 테이블이 없으면 `CREATE TABLE IF NOT EXISTS`로 생성
- **INGEST_EXCEL_PATH** 환경변수에 엑셀 경로 지정

---

## 7. 환경·실행

- **.env**: `OPENAI_API_KEY`, DB 접속 정보(Option A: `DB_URL` / Option B: `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`), (선택) `INGEST_EXCEL_PATH`, `RECOMMEND_MODE`, `OPENAI_TIMEOUT_SECONDS`, `CHAT_MODEL`
- **실행**: Docker 빌드 후 컨테이너 실행 또는 로컬 `uvicorn app.main:app --host 0.0.0.0 --port 8001`
- **Java 팀**: Python 설치 없이 **Docker만으로 AI 서비스 실행·연동 가능**

---

## 8. 한 줄 요약

**"내담자 프로필(나이·성별·희망직종)으로 임베딩 → DB 유사 케이스 Top-K 검색 → 규칙+GPT로 직무·훈련·급여·서비스·상담 질문 추천, 이름·주민번호는 마스킹 후 GPT 전달"**
